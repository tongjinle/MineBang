var __reflect=this&&this.__reflect||function(t,e,o){t.__class__=e,o?o.push(e):o=[e],t.__types__=t.__types__?o.concat(t.__types__):o},__extends=this&&this.__extends||function(t,e){function o(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)},Box=function(){function t(t,e,o,n,i){void 0===n&&(n=!1),void 0===i&&(i=!1),this.x=t,this.y=e,this.type=o,this.isWarn=n,this.isWarnWrong=i,this.touchDict={},this.touchDict[BoxType.num]=function(t){var e=t;e.isClean?Game.getIns().fire("numBox.batch",e):(e.isClean=!0,Game.getIns().fire("numBox.expand",e))},this.touchDict[BoxType.boom]=function(t){var e=t;e.isBoom||(e.isBoom=!0,Game.getIns().fire("boomBox.boom",e))}}return t.prototype.touch=function(){this.touchDict[this.type](this),Game.getIns().fire("box.touch",{box:this})},t.prototype.warn=function(){this.isWarn=!this.isWarn,Game.getIns().fire("box.warn",this)},t}();__reflect(Box.prototype,"Box");var Game=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.getIns=function(){return e._game=e._game||new e,e._game},e.prototype.on=function(t,e,o){this.addEventListener(t,e,o)},e.prototype.off=function(t,e,o){this.removeEventListener(t,e,o)},e.prototype.fire=function(t,e){this.dispatchEvent(new egret.Event(t,!1,!1,e))},e.prototype.startGame=function(){this.boxMap=new BoxMap(Config.width,Config.height,Config.ratio),this.boxMap.firstTip()},e.prototype.bind=function(){e.getIns().on("game.pass",function(){RES.getRes("win_mp3").play(0,1),e.getIns().fire("game.over",null)},this)},e}(egret.EventDispatcher);__reflect(Game.prototype,"Game");var BoomBox=function(t){function e(e,o){return t.call(this,e,o,BoxType.boom)||this}return __extends(e,t),Object.defineProperty(e.prototype,"isBoom",{get:function(){return this._isBoom},set:function(t){this._isBoom=t,this._isBoom&&Game.getIns().fire("boomBox.boom",this)},enumerable:!0,configurable:!0}),e}(Box);__reflect(BoomBox.prototype,"BoomBox");var Config=function(){function t(){}return t}();Config.size=64,Config.width=10,Config.height=8,Config.mapHeight=512,Config.ratio=.2,Config.longTouchInterval=600,__reflect(Config.prototype,"Config");var BoxMap=function(){function t(t,e,o){void 0===o&&(o=.2),this.width=t,this.height=e,this.ratio=o,this.cleanCount=0,this.boxList=[],this.seedBoom(),this.mark(),this.bind()}return t.prototype.seedBoom=function(){for(var t=this.boomCount=Math.floor(this.width*this.height*this.ratio),e={};t--;)for(var o=!0;o;){var n=Math.floor(Math.random()*this.width),i=Math.floor(Math.random()*this.height);void 0===e[n+"-"+i]&&(e[n+"-"+i]={x:n,y:i},o=!1)}for(var r=0;r<this.height;r++){var s=[];s.length=this.width,this.boxList.push(s)}for(var r in e){var a=e[r];this.boxList[a.y][a.x]=new BoomBox(a.x,a.y)}},t.prototype.mark=function(){for(var t=this,e=function(e,o,n){if(!t.boxList[n][o]){for(var i=[{x:o-1,y:n-1},{x:o,y:n-1},{x:o+1,y:n-1},{x:o-1,y:n},{x:o,y:n},{x:o+1,y:n},{x:o-1,y:n+1},{x:o,y:n+1},{x:o+1,y:n+1}],r=0,s=0,a=i;s<a.length;s++){var h=a[s];if(h.x>=0&&h.x<t.width&&h.y>=0&&h.y<t.height){var u=e[h.y][h.x];u&&u.type==BoxType.boom&&r++}}var c=t.boxList[n][o]=new NumBox(o,n);c.num=r}},o=0;o<this.height;o++)for(var n=0;n<this.width;n++)e(this.boxList,n,o)},t.prototype.check=function(){var t=this,e=this._check=_.debounce(function(){for(var e=0;e<t.height;e++)for(var o=0;o<t.width;o++){var n=t.boxList[e][o];if(n.type==BoxType.num&&!n.isClean)return}Game.getIns().fire("game.pass",null)},100);e()},t.prototype.firstTip=function(){for(var t=0;t<this.height;t++)for(var e=0;e<this.width;e++){var o=this.boxList[t][e];if(o.type==BoxType.num){var n=o;if(0==n.num)return void n.touch()}}},t.prototype.getNear=function(t,e,o){var n,i=this,r=[];return"circle"==o?n=[{x:t-1,y:e-1},{x:t,y:e-1},{x:t+1,y:e-1},{x:t-1,y:e},{x:t,y:e},{x:t+1,y:e},{x:t-1,y:e+1},{x:t,y:e+1},{x:t+1,y:e+1}]:"line"==o&&(n=[{x:t,y:e-1},{x:t,y:e+1},{x:t-1,y:e},{x:t+1,y:e}]),n.forEach(function(t){t.x>=0&&t.x<i.width&&t.y>=0&&t.y<i.height&&r.push(i.boxList[t.y][t.x])}),r},t.prototype.onBoxTouch=function(t){var e=t.data;console.log(e)},t.prototype.onNumBoxClean=function(t){console.log("numBox.clean");var e=t.data;Game.getIns().fire("render.numBox.clean",e),this.cleanCount++,Game.getIns().fire("render.numBox.refreshCleanCount",this.cleanCount),this.check()},t.prototype.onNumBoxExpand=function(t){var e=t.data,o=this.getNear(e.x,e.y,"line");o.forEach(function(t){if(t.type==BoxType.num){var o=t;o.isClean||0!=e.num&&0!=o.num||t.touch()}})},t.prototype.onNumBoxBatch=function(t){var e=t.data,o=this.getNear(e.x,e.y,"circle"),n=0,i=0,r=[],s=[];o.forEach(function(t){t.isWarn?(n++,t.type==BoxType.boom?i++:r.push(t)):t.type==BoxType.boom&&s.push(t)}),e.num==n&&(n==i?o.forEach(function(t){!t||t.type!=BoxType.num||t.isWarn||t.isClean||t.touch()}):(r.forEach(function(t){t.isWarnWrong=!0}),Game.getIns().fire("render.box.warn.wrong",r),Game.getIns().fire("boomBox.boom",s[0])))},t.prototype.onBoomBoxBoom=function(t){var e=t.data;Game.getIns().fire("render.boomBox.boom",e),Game.getIns().fire("game.over",null)},t.prototype.onBoxWarn=function(t){var e=t.data;Game.getIns().fire("render.box.warn",e)},t.prototype.bind=function(){Game.getIns().on("box.touch",this.onBoxTouch,this),Game.getIns().on("numBox.clean",this.onNumBoxClean,this),Game.getIns().on("numBox.expand",this.onNumBoxExpand,this),Game.getIns().on("numBox.batch",this.onNumBoxBatch,this),Game.getIns().on("boomBox.boom",this.onBoomBoxBoom,this),Game.getIns().on("box.warn",this.onBoxWarn,this)},t.prototype.unbind=function(){Game.getIns().off("box.touch",this.onBoxTouch,this)},t}();__reflect(BoxMap.prototype,"BoxMap");var BoxType;!function(t){t[t.num=0]="num",t[t.boom=1]="boom"}(BoxType||(BoxType={}));var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.setProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI");var NumBox=function(t){function e(e,o){var n=t.call(this,e,o,BoxType.num)||this;return n.num=0,n}return __extends(e,t),Object.defineProperty(e.prototype,"isClean",{get:function(){return this._isClean},set:function(t){this._isClean=t,this._isClean&&Game.getIns().fire("numBox.clean",this)},enumerable:!0,configurable:!0}),e}(Box);__reflect(NumBox.prototype,"NumBox");var Main=function(t){function e(){var e=t.call(this)||this;return e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},e.prototype.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},e.prototype.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.createGameScene())},e.prototype.onItemLoadError=function(t){console.warn("Url:"+t.resItem.url+" has failed to load")},e.prototype.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},e.prototype.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},e.prototype.createGameScene=function(){var t=this.myGame=Game.getIns();t.bind(),t.startGame();var e=this.boxMap=t.boxMap;console.log(e);var o=this.boxMapSp=new BoxMapSp(e);this.addChild(o),console.log(this.stage.width,this.stage.stageWidth);var n=this.hubSp=new HubSp;n.y=this.stage.height-200,n.totalCount=e.width*e.height-e.boomCount,n.cleanCount=e.cleanCount,n.status="playing",this.addChild(n)},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,o=RES.getRes(t);return e.texture=o,e},e.prototype.startAnimation=function(t){for(var e=this,o=new egret.HtmlTextParser,n=[],i=0;i<t.length;i++)n.push(o.parser(t[i]));var r=e.textfield,s=-1,a=function(){s++,s>=n.length&&(s=0);var t=n[s];e.changeDescription(r,t);var o=egret.Tween.get(r);o.to({alpha:1},200),o.wait(2e3),o.to({alpha:0},200),o.call(a,e)};a()},e.prototype.changeDescription=function(t,e){t.textFlow=e},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var BoxMapSp=function(t){function e(e){var o=t.call(this)||this;o.boxMap=e,o.longTouchInterval=Config.longTouchInterval,o.onTouch=function(t){console.log(t.type);var e=Math.floor(t.stageX/Config.size),n=Math.floor(t.stageY/Config.size);console.log(e,n);var i=function(t,e){if(t&&e&&t.x==e.x&&t.y==e.y){var n=o.boxMap.boxList[e.y][e.x];e.timeStamp-t.timeStamp<o.longTouchInterval?(console.log("touch box"),n.touch()):(console.log("warn box"),n.warn())}o.touchBegin=o.touchEnd=null};e>=0&&e<o.boxMap.width&&n>=0&&n<o.boxMap.height&&(t.type==egret.TouchEvent.TOUCH_BEGIN?(o.touchBegin={x:e,y:n,timeStamp:(new Date).getTime()},o.timeHandle=setTimeout(function(){o.touchEnd=o.touchEnd||{x:o.touchBegin.x,y:o.touchBegin.y,timeStamp:1/0},i(o.touchBegin,o.touchEnd)},o.longTouchInterval)):t.type==egret.TouchEvent.TOUCH_END?(o.touchEnd={x:e,y:n,timeStamp:(new Date).getTime()},i(o.touchBegin,o.touchEnd),clearTimeout(o.timeHandle)):t.type==egret.TouchEvent.TOUCH_MOVE&&(console.log("touch move"),o.touchEnd={x:e,y:n,timeStamp:(new Date).getTime()}))},o.initBg();var n=o.boxMap.boxList,i=o.boxSpList=[];i.length=o.boxMap.height;for(var r=0;r<o.boxMap.height;r++){i[r]=[];for(var s=0;s<o.boxMap.width;s++){var a=n[r][s],h=new BoxSp(a);i[r][s]=h,o.addChild(h)}}return o.width=Config.width,o.height=Config.mapHeight,o.bind(),o}return __extends(e,t),e.prototype.initBg=function(){var t=new egret.Bitmap(RES.getRes("bg_jpg"));this.addChild(t)},e.prototype.onNumBoxClean=function(t){console.log("render.numBox.clean");var e=t.data;this.boxSpList[e.y][e.x].refreshTexture()},e.prototype.onBoomBoxBoom=function(t){console.log("render.boomBox.boom");var e=t.data;this.boxSpList[e.y][e.x].refreshTexture(),RES.getRes("crash2_mp3").play(0,1)},e.prototype.onBoxWarn=function(t){var e=t.data;this.boxSpList[e.y][e.x].refreshTexture()},e.prototype.onBoxWarnWrong=function(t){var e=this,o=t.data;o.forEach(function(t){e.boxSpList[t.y][t.x].refreshTexture()})},e.prototype.bind=function(){var t=this;Game.getIns().on("render.numBox.clean",this.onNumBoxClean,this),Game.getIns().on("render.boomBox.boom",this.onBoomBoxBoom,this),Game.getIns().on("render.box.warn",this.onBoxWarn,this),Game.getIns().on("render.box.warn.wrong",this.onBoxWarnWrong,this),this.touchEnabled=!0,this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouch,this),this.addEventListener(egret.TouchEvent.TOUCH_END,this.onTouch,this),this.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouch,this),Game.getIns().on("game.over",function(){t.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,t.onTouch,t)},this)},e.prototype.unbind=function(){},e}(egret.Sprite);__reflect(BoxMapSp.prototype,"BoxMapSp");var BoxSp=function(t){function e(e){var o=t.call(this)||this;o.box=e,o.x=o.box.x*Config.size,o.y=o.box.y*Config.size;var n=o.bitMap=new egret.Bitmap(o.getTexture(o.box));return o.addChild(n),o}return __extends(e,t),e.prototype.getTexture=function(t){var e;if(this.box.isWarn)e="flag_png",this.box.isWarnWrong&&(e="fail_png");else if(this.box.type==BoxType.num){var o=this.box;e=o.isClean?o.num+"_png":"none_png"}else if(this.box.type==BoxType.boom){var n=this.box;e=n.isBoom?"bomb_png":"none_png"}return RES.getRes(e)},e.prototype.refreshTexture=function(){this.bitMap.texture=this.getTexture(this.box)},e}(egret.Sprite);__reflect(BoxSp.prototype,"BoxSp");var HubSp=function(t){function e(){var e=t.call(this)||this;return e.boxCountStr=new egret.TextField,e.statusStr=new egret.TextField,e.boxCountStr.x=50,e.boxCountStr.y=100,e.addChild(e.boxCountStr),e.statusStr.x=490,e.statusStr.y=100,e.status="playing",e.addChild(e.statusStr),e.bind(),e}return __extends(e,t),Object.defineProperty(e.prototype,"cleanCount",{get:function(){return this._cleanCount},set:function(t){this._cleanCount=t,this.boxCountStr.text=this._cleanCount+"-"+this.totalCount},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"status",{get:function(){return this._status},set:function(t){this._status=t,this.statusStr.text=""+this._status,this.statusStr.textColor={playing:65280,fail:2236962,win:16711680}[this._status]},enumerable:!0,configurable:!0}),e.prototype.bind=function(){var t=this;Game.getIns().on("boomBox.boom",function(){t.status="fail"},this),Game.getIns().on("game.pass",function(){t.status="win"},this),Game.getIns().on("render.numBox.refreshCleanCount",function(e){t.cleanCount=e.data},this)},e}(egret.Sprite);__reflect(HubSp.prototype,"HubSp");